# Implémenter une page de détail

## Objectifs

L'objectif de cet exercise et de pouvoir afficher une page de détail d'un film.

Elle est constituée :

-   d'un header ([Cartridge](https://github.com/KleeGroup/focus-components/blob/master/src/page/mixin/cartridge-behaviour.js))
-   d'une zone de navigation rapide ([Scrollspy](https://github.com/KleeGroup/focus-components/tree/master/src/components/scrollspy-container))
-   d'un ou plusieurs blocks de détail ([Panel](https://github.com/KleeGroup/focus-components/tree/master/src/components/panel))

Une page de détail ressemble à ça :

![page de détail focus](images/detail.png)

## Concepts focus manipulés

### Le CoreStore

Focus propose un store simple qui permet de stocker n-noeuds par store. L'idée est que chaque store couvre un thème fonctionnel de l'application.
Par exemple, un store `movieStore`

### Le ActionBuilder

### Le Panel

### Le FormMixin

## Création de la page

Commençons par créer un dossier pour l'ensemble des composants de cette page de détail, dans notre dossier de vues: `views`.

La manière dont vous organisez votre dossier de vues vous incombe, cependant une bonne pratique est de regrouper les vues par module puis par écran.

Dans notre cas, nous créons le dossier : `views/movies/movie-detail`.

Créons notre composant parent :

```js
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from "react";

export const MovieDetailPage = React.createClass({
    render() {
        const { id } = this.props;

        return <div>{`Page de détail du movie ${id}`}</div>;
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

<!-- prettier-ignore-start -->
!!! note
    Ici on utilise `React.createClass` car nous allons ajouter un mixin plus tard dans l'exercise
<!-- prettier-ignore-end -->

Notre page de détail est pour l'instant très simple, elle n'a qu'une _prop_, `id`, qui lui sera fournie par le routeur lorsque l'on navigue vers l'URI `/#movies/{id}`.

Il faut donc créer un nouveau fichier pour les routes de movies :

```js
// app/routes/movie-routes.jsx

// Libs
import React from "react";

// Components
import { MovieDetailPage } from "../views/movies/movie-detail";

export const movieRoutes = [
    {
        path: "movies/:id",
        component: ({ params }) => <MovieDetailPage id={params.id} />
    }
];
```

Puis l'enregistrer auprès du router :

```diff
// app/routes/index.js

// Components
import AppLayout from "../components/app-layout";

// Routes
import { homeRoutes } from "./home-routes";
+++ import { movieRoutes } from "./movie-routes";

export default {
    path: `${__BASE_URL__}`,
    component: AppLayout,
    indexRoute: { onEnter: ({ params }, replace) => replace(`${__BASE_URL__}home`) },
---    childRoutes: [...homeRoutes]
+++    childRoutes: [...homeRoutes, ...movieRoutes]
};
```

## Ajout du premier pannel de détail

### Mise en place du composant

Les attributs de notre entités vont être présentés à travers des [pannels](https://github.com/KleeGroup/focus-components/blob/master/src/components/panel/index.js).

Nous allons créer un premier pannel, pour afficher et éditer les caractéristiques principales de notre **movie**.

```js
// app/views/movies/movie-detail/movie-characteristics.jsx

// Libs
import React, { PropTypes } from "react";

// Components
import { Panel } from "focus-components/components";

export const MovieCharacteristics = React.createClass({
    render() {
        const { id } = this.props;
        return (
            <Panel title="view.movie.detail.characteristics">
                <div>{`Panneau de caractéristiques du film ${id}`}</div>
            </Panel>
        );
    }
});
MovieCharacteristics.propTypes = {
    id: PropTypes.number.isRequired
};
```

On instancie le bloc dans la page :

```diff
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from "react";

+++ // Components
+++ import { MovieCharacteristics } from "./movie-characteristics";

export const MovieDetailPage = React.createClass({
    render() {
        const { id } = this.props;

---        return <div>{`Page de détail du movie ${id}`}</div>;
+++        return <MovieCharacteristics id={id} />;
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

Notre premier panneau est maintenant prêt à recevoir les données depuis le store applicatif, et à faire les appels serveurs permettant le chargement de l'entité dans les store.

### Chargement de l'entité en mémoire

Le chargement de l'entité passe par les stores applicatif, en suivant l'architecture **flux**.

Il est donc nécessaire de lancer une action qui va effectuer le chargement serveur de l'entité, et de s'abonner aux changements du store de l'entité afin de bénéficier des données retournées par le serveur.

Nous allons donc créer les actions et les services associés aux manipulations de cette entité.

```js
// app/actions/movies.js

// Libs
import actionBuilder from "focus-core/application/action-builder";

// Services
import { movieServices } from "../services/movies";

export const movieActions = {
    movieCharacteristics: {
        load: actionBuilder({
            node: "movieCharacteristics",
            service: movieServices.loadMovieCharacteristics,
            shouldDumpStoreOnActionCall: true,
            status: "loaded"
        }),
        save: actionBuilder({
            node: "movieCharacteristics",
            service: movieServices.updateMovieCharacteristics,
            shouldDumpStoreOnActionCall: false,
            status: "saved"
        })
    }
};
```

```js
// app/services/movies.js

// Apis
import moviesApi from "../config/server/generated/movies";

export const movieServices = {
    loadMovieCharacteristics(id) {
        return moviesApi.getMovie({ id });
    },
    updateMovieCharacteristics(movie) {
        const movieId = movie.id;
        return moviesApi.updateMovie({ id: movieId }, movie);
    }
};
```

Notre entité **movie** dispose maintenant de deux méthodes de manipulation, un **load** et et un **save**.

Il est ensuite necessaire de créer le fichier `config/server/movies.js`.
Le mieux est d'utiliser le paquet [focus-service-generator](https://github.com/KleeGroup/focus-service-generator) (il est configuré avec ce starter kit)

Exécutez :

```bash
npm run generate
```

Cela va générer un fichier de la forme suivante :

```js
// app/config/server/generated/movies.js

import apiDriverBuilder from "../../../utilities/api-driver";

// Movies
export default apiDriverBuilder({
    getMovie: {
        url: __API_ROOT__ + "/api/movie/${id}",
        method: "GET"
    },
    updateMovie: {
        url: __API_ROOT__ + "/api/movie/${id}",
        method: "PUT"
    }
});
```

Appelons le load au chargement de la page de détail afin de disposer des données dans le store et donc dans les vues :

```diff
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from 'react';

+++ // Actions
+++ import { movieActions } from '../../../actions/movies';

export const MovieDetailPage = React.createClass({
+++     componentDidMount() {
+++         movieActions.movieCharacteristics.load();
+++     },

    render() {
        const { id } = this.props;

        return <MovieCharacteristics id={id} />;
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

### Affichage de l'entité

Maintenant que l'entité est chargée en mémoire au montage de la page de détail, il est possible de l'afficher dans le pannel **movieCharacteristics**.

Pour cela, nous allons utiliser le **formMixin** dans le pannel. Il va nous faire bénéficier de l'ensemble des fonctionnalités du form focus, à savoir :

-   l'abonnement aux stores,
-   le chargement des définitions avec domaines associés,
-   les helpers de field,
-   et le branchement aux actions de l'entité `load` et `save`.

```diff
// app/views/movies/movie-detail/movie-characteristics.jsx

// Libs
import React, { PropTypes } from 'react';
+++ import { mixin as formMixin } from 'focus-components/mixin/form';

// Actions & Stores
import { movieActions } from '../../../actions/movies';
+++ import { movieDetailStore } from '../../../stores/movies';

// Components
import { Panel } from 'focus-components/components';

export const MovieCharacteristics = React.createClass({
+++    mixins: [formMixin], // Ajout du form mixin
+++    definitionPath: 'movie', // Définition de notre entité
+++    stores: [{ store: movieDetailStore, properties: ['movieCharacteristics'] }], // Abonnement au store
+++    action: movieActions.movieCharacteristics, // Donne les actions au form
---    render() {
---        const { id } = this.props;
+++    renderContent() {
            return (
---            <Panel title='view.movie.detail.characteristics'>
+++            <Panel actions={this._renderActions} title='views.movie.detail.characteristics'>
---            <div>{`Panneau de caractéristiques du film ${id}`}</div>
+++                {/* Les fieldFor sont des fonctions helper pour afficher et éditer un champ avec label} */}
+++                {this.fieldFor('title')}
+++                {this.fieldFor('originalTitle')}
+++                {this.fieldFor('keywords')}
+++                {this.fieldFor('runtime')}
+++                {this.fieldFor('movieType')}
+++                {this.fieldFor('productionYear')}
                </Panel>
            );
        }
});
MovieCharacteristics.propTypes = {
    id: PropTypes.number.isRequired
};
```

Il est important d'ajouter une **prop** depuis le parent vers `MovieCharacteristics` afin de lui signaler de ne pas effectuer le **load** à son chargement, le composant parent le fait déjà dans son `componentDidMount`. Par défaut, le **formMixin** se chargerait de le faire en appelant le `load(this.props.id)`.

Faire le chargement dans le parent permet de s'assurer qu'il n'est fait qu'une fois pour l'ensemble des enfants.

```diff
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from 'react';

// Actions
import { movieActions } from '../../../actions/movies';

// Components
import { MovieCharacteristics } from "./movie-characterics";

export const MovieDetailPage = React.createClass({
    componentDidMount() {
        movieActions.movieCharacteristics.load();
    },

    render() {
        const { id } = this.props;

---        return <MovieCharacteristics id={id} />;
+++        return <MovieCharacteristics id={id} hasLoad={false} />;
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

## Ajout d'un second pannel

Nous allons ajouter un pannel propre au synopsis du movie, afin de séparer l'information et de rendre plus limpide la lecture de la page de détail.

Le synopsis est un attribut de notre entité, on bénéficie donc déjà de l'information dans le noeud `movieCharacteristics` du `movieDetailStore`.

```js
// app/views/movies/movie-detail/movie-synopsis.jsx

// Libs
import React, { PropTypes } from "react";
import { mixin as formMixin } from "focus-components/mixin/form";

// Actions & Stores
import { movieActions } from "../../../actions/movies";
import { movieDetailStore } from "../../../stores/movies";

// Components
import { Panel } from "focus-components/components";

export const MovieSynopsis = React.createClass({
    mixins: [formMixin],
    definitionPath: "movie",
    stores: [{ store: movieDetailStore, properties: ["movieCharacteristics"] }],
    action: movieActions.movieCharacteristics,

    renderContent() {
        return (
            <Panel actions={this._renderActions} title="views.movie.detail.synopsis">
                {this.fieldFor("synopsis")}
            </Panel>
        );
    }
});
MovieSynopsis.propTypes = {
    id: PropTypes.number.isRequired
};
```

```diff
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from "react";

// Actions
import { movieActions } from "../../../actions/movies";

// Components
import { MovieCharacteristics } from "./movie-characterics";
+++ import { MovieSynopsis } from "./movie-synopsis";

export const MovieDetailPage = React.createClass({
    componentDidMount() {
        movieActions.movieCharacteristics.load();
    },

    render() {
        const { id } = this.props;

        return (
            <>
                <MovieCharacteristics id={id} hasLoad={false} />;
+++             <MovieSynopsis id={id} hasLoad={false} />;
            </>
        );
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

## Ajout de la navigation rapide

La navigation rapide est rapidemment mise en place. En effet, il s'agit d'un simple wrapper [ScrollspyContainer](https://github.com/KleeGroup/focus-components/blob/master/src/components/scrollspy-container/index.js) autour de nos pannels, qui va de lui-même lister les pannels et mettre en place la navigation.

```diff
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from "react";

// Actions
import { movieActions } from "../../../actions/movies";

// Components
+++ import ScrollspyContainer from "focus-components/components/scrollspy-container";
import { MovieCharacteristics } from "./movie-characterics";
import { MovieSynopsis } from "./movie-synopsis";

export const MovieDetailPage = React.createClass({
    componentDidMount() {
        movieActions.movieCharacteristics.load();
    },

    render() {
        const { id } = this.props;

        return (
---         <>
+++         <ScrollspyContainer>
                <MovieCharacteristics id={id} hasLoad={false} />;
                <MovieSynopsis id={id} hasLoad={false} />;
---         </>
+++         </ScrollspyContainer>
        );
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

## Ajout du header

Pour finaliser notre page de détail, nous allons ajouter des éléments dans le header (ou Cartridge).

Le header a deux modes de fonctionnement : déplié et replié. Il faut donc lui fournir un composant pour chaque mode.

Le store étant déjà peuplé par le composant de la page de détail, on peut donc simplement utiliser le **formMixin** pour s'abonner au store et afficher les champs qui nous intéressent.

### Création des composants

```js
// app/views/movies/movie-detail/header-expanded.jsx

// Libs
import React from "react";
import { mixin as formMixin } from "focus-components/mixin/form";

// Actions & Stores
import { movieDetailStore } from "../../../stores/movies";

// Components
import Poster from "../components/poster";

export const MovieHeaderExpanded = React.createClass({
    displayName: "MovieHeaderExpanded",
    mixins: [formMixin],
    definitionPath: "movie",
    stores: [{ store: movieDetailStore, properties: ["movieCharacteristics"] }],
    renderContent() {
        const { poster, title } = this.state;

        return (
            <div>
                {poster && <Poster poster={poster} title={title} />}
                <h3>{this.textFor("title")}</h3>
                <h5>{this.textFor("movieType")}</h5>
                <h6>{this.textFor("productionYear")}</h6>
                <div>{this.textFor("shortSynopsis")}</div>
            </div>
        );
    }
});
```

Le composant de header replié est similaire, avec quelques informations en moins pour occuper moins de place.

```js
// app/views/movies/movie-detail/header-collapsed.jsx

// Libs
import React from "react";
import { mixin as formMixin } from "focus-components/mixin/form";

// Actions & Stores
import { movieDetailStore } from "../../../stores/movies";

export const MovieHeaderCollapsed = React.createClass({
    displayName: "MovieHeaderCollapsed",
    mixins: [formMixin],
    definitionPath: "movie",
    stores: [{ store: movieDetailStore, properties: ["movieCharacteristics"] }],
    renderContent() {
        return (
            <div>
                <h3>{this.textFor("title")}</h3>
                <h6>{this.textFor("productionYear")}</h6>
            </div>
        );
    }
});
```

### Injection des composants dans le header

Nos composants de header sont définis, mais ne sont pas injectés dans le header.

Pour ce faire, on peut utiliser le [cartridgeBehaviour](https://github.com/KleeGroup/focus-components/blob/master/src/page/mixin/cartridge-behaviour.js), qui va permettre d'indiquer à la page quels composants afficher dans le header, ainsi que les actions globales disponibles en tant que boutons dans le header.

Modifions la page parente afin de lui donner le cartridgeBehaviour et d'envoyer les composants dans le header.

```diff
// app/views/movies/movie-detail/index.jsx

// Libs
import React, { PropTypes } from "react";
+++ import { cartridgeBehaviour } from "focus-components/page/mixin";

// Actions
import { movieActions } from "../../../actions/movies";

// Components
import ScrollspyContainer from "focus-components/components/scrollspy-container";
+++ import BackButton from "focus-components/components/button-back/";
import { MovieCharacteristics } from "./movie-characterics";
import { MovieSynopsis } from "./movie-synopsis";
+++ import { MovieHeaderCollapsed } from "./header-collapsed";
+++ import { MovieHeaderExpanded } from "./header-expanded";

export const MovieDetailPage = React.createClass({
    componentDidMount() {
        movieActions.movieCharacteristics.load();
    },
+++ mixins: [cartridgeBehaviour],
+++ cartridgeConfiguration() {
+++     const props = { hasLoad: false, hasForm: false }; // props qui seront données aux composants du header
+++     return {
+++         barLeft: { component: BackButton }, // On ajoute le bouton Back en haut à gauche de la page
+++         cartridge: { component: MovieHeaderExpanded, props },
+++         summary: { component: MovieHeaderCollapsed, props },
+++         actions: {
+++             primary: [
+++                 {
+++                     // action d'exemple
+++                     label: "Imprimer",
+++                     icon: "print",
+++                     action: () => {
+++                         alert("todo print");
+++                     }
+++                 }
+++             ],
+++             secondary: []
+++         }
+++     };
+++ }
    render() {
        const { id } = this.props;

        return (
            <ScrollspyContainer>
                <MovieCharacteristics id={id} hasLoad={false} />;
                <MovieSynopsis id={id} hasLoad={false} />;
            </ScrollspyContainer>
        );
    }
});
MovieDetailPage.propTypes = {
    id: PropTypes.number.isRequired
};
```

## Epilogue

![](https://media.giphy.com/media/lgIyvBoSKEhuo/giphy.gif)
